<div class="row">
    <div class="col-xs-4">
        <div class="pull-left">
        <a href="/"><i class="fa fa-home" aria-hidden="true"></i> Home</a>
        </div>
    </div>

    <div class="col-xs-8">
        <div class="dropdown pull-right">
            <a
            
             class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                <i class="fa fa-shopping-cart" aria-hidden="true"></i> Cart
                {{# if session.cart.totalItems }}
                <span>({{session.cart.totalItems}})</span>
                {{/if}}
            </a>
            {{# if session.cart.totalItems }}
            <div class="dropdown-menu">
                <div class="cart">
                    {{# each session.cart.items }}
                    <div class="row">
                        <div class="col-xs-4">
                            {{ this.item.title }}
                        </div>
                        <div class="col-xs-4 text-right">
                            <span class="badge">{{ this.quantity }}</span>
                        </div>
                        <div class="col-xs-4 text-right">
                            {{ this.price }} 
                        </div>
                    </div>
                    {{/each}}
                    <div class="row">
                        <div class="text-right">
                            <div class="totalPrice">Total: {{ session.cart.totalPrice }} </div>
                            <a href="/cart/" class="btn btn-success">Procceed</a>
                        </div>
                    </div>
                </div>
            </div>
            {{/if}}
        </div>
    </div>

    <div class="col-xs-6">
        <div class="pull-left">
        <a href="/main/"><i class="fa fa-money" aria-hidden="true"></i> Balance: {{money}}</a>
        </div>
    </div>

    {{!-- <div class="col-xs-6">
        <div class="dropdown pull-right">
            <a class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                <i class="fa fa-cart-plus" aria-hidden="true"></i> Upload
            </a>

            <div class="dropdown-menu" style="width: 300px;">
                <form class="px-4 py-3">
                    <div class="form-group" style="width: 260px; margin-left: 15px;">
                        <input type="text" class="form-control" id="id_text" placeholder="Item name">
                    </div>
                    <div class="form-group" style="width: 260px; margin-left: 15px;">
                        <input type="text" class="form-control" id="price_text" placeholder="Item price">
                    </div>
                    <div class="form-group" style="width: 260px; margin-left: 15px;">
                        <input type="text" class="form-control" id="count_text" placeholder="Item count">
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-success" id="upload_btn">Upload Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div> --}}

    <div class="col-xs-6">
        <div class="dropdown pull-right">
            <a class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                <i class="fa fa-cart-plus" aria-hidden="true">Upload</i> 
            </a>

            <div class="dropdown-menu">

                <input class="dropdown-item" type="text" id="id_text" placeholder="item name">
                <input class="dropdown-item" type="text" id="price_text" placeholder="item price">
                <input class="dropdown-item" type="text" id="count_text" placeholder="item count">
                <button class="dropdown-item" id="upload_btn" >Upload Item</button>
                <span class="label label-primary"><label for="file">Upload Picture</label></span>
                
                <form action="" method="">
                    <input type="file" id="file">
                    <img src="" alt="" id="myimg"/>
                </form>

            </div>
        </div>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

<script>


const new_dep1 = async (name) => {
    let body = {
      name: name,
    };
  
    console.log('/new/' + name);

    // Actually send it
    makePost1('/new/' + name, body)
    .then(ret => {
      console.log(ret);
    }); 
}
  
const get1 = async (name) => {
    let body = {
      name: name,
    };

    var src = "/get/1/" + name;

    console.log(src);

  
    // Actually send it
    makePost1(src, body)
    .then((ret) => {
      //value.value = ret;
      //username = name;
      //money = ret;
      //return ret;
    });
    // Clear the DOM to prevent double posts
    //value.value = "";
}
  
const set1 = async (name, value) => {
    let body = {
      name: name,
      value: value,
    };

    console.log(value)

    var src = "/set/" + name + "/" + value;
  
    console.log(src);

    makePost1(src, body)
    .then(ret => {
      console.log(ret);
    });
  
}
  
const makePost1 = async (route, body) => {
    let request = {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-type': 'application/json',
      }
    };
  
    return fetch(route, request)
    .then(ret => {return ret.json()});
}

const makerealPost1 = async (route, body) => {
    let request = {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-type': 'application/json',
      },
      body: JSON.stringify(body)
    };
  
    return fetch(route, request)
    .then(ret => {return ret.json()});
}


var url = "";
var pic = "";
// "9bec7437-6813-4dc6-a47e-eb5825d715c3"
// blob:http://localhost:3000/

document.getElementById('upload_btn').addEventListener('click', async function(){
    var name = document.getElementById("id_text").value;
    var price = document.getElementById("price_text").value;
    var count = document.getElementById("count_text").value;

    new_dep1(`${name}`).then(
        () => {
            set1(`${name}`, "" + price + "," + count);
        
            var src = "/newitem/" + name + "/" + price + "/" + count + "/" + pic;
            console.log(src);
            // makePost1(src, name).then(
            //     () => {
            //         //location.reload();
            //     }
            // );

            let body = {
              name: name,
              price: price,
              count: count,
              pic: "" + pic,
            };


            // Actually send it
            makerealPost1('/newitem', body)
            .then(res => {
              console.log(res);
            });
            
        }
    );

    

});





var myimg = document.getElementById('myimg');
var file = document.getElementById('file');
file.onchange = function(){
    var agent = navigator.userAgent;   //检测浏览器版本
    if (agent.indexOf("MSIE")>=1) {
      url = file.value;
    } else if(agent.indexOf("Firefox")>0) {
      url = window.URL.createObjectURL(file.files.item(0));
    } else if(agent.indexOf("Chrome")>0) {
      url = window.URL.createObjectURL(file.files.item(0));
    }
    myimg.src = url
    console.log(url.substring(27, url.length - 1));
    myimg.style.display = "block";

    var reader = new FileReader();
    reader.readAsDataURL(file.files.item(0));
    reader.onload = function(e) {
                   // console.log(e); //查看对象
                   // console.log(encodeURIComponent(this.result));//要的数据 这里的this指向FileReader（）对象的实例readers
                    //pic = encodeURIComponent(this.result);
                    pic = (this.result);
    }

}


</script>


<style>


#file{
    display: none;
}
#file + label{
    display: inline-block;
    width: 100px;
    height: 30px;
    background-color: rgb(90, 152, 222);
    text-align: center;
    line-height: 30px;
    border-radius: 5px;
}
img{
    display: none;
    width: 200px;
    height: 200px;
}

</style>